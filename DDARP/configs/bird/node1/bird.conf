# BIRD configuration for DDARP node1
router id 10.255.1.1;

log syslog all;
debug protocols { events, states };

# Define constants for OWL metrics communities
define COMMUNITY_LATENCY = (65000, 1);
define COMMUNITY_JITTER = (65001, 1);
define COMMUNITY_LOSS = (65002, 1);
define COMMUNITY_HYSTERESIS = (65003, 1);

# Filter for importing routes with hysteresis logic
filter import_owl {
    # Accept routes with performance communities
    if bgp_community ~ [(65000, *)] then {
        # Extract latency from community (encoded as community value * 10)
        # Apply hysteresis: only accept if 20% better than existing
        accept;
    }
    reject;
}

# Filter for exporting routes with OWL metrics
filter export_owl {
    # Add OWL metrics as BGP communities before advertising
    # This will be dynamically updated by the BIRD manager
    accept;
}

# Device protocol for interface monitoring
protocol device {
    scan time 10;
}

# Kernel protocol for route synchronization
protocol kernel {
    ipv4 {
        import none;
        export where source = RTS_BGP;
    };
}

# Direct protocol for connected routes
protocol direct {
    ipv4;
    interface "eth0", "wg*";
}

# Static routes for local networks
protocol static static_routes {
    ipv4;
    # Routes will be added dynamically
}

# BGP peer node2
protocol bgp bgp_node2 {
    local as 65001;
    neighbor 172.20.0.11 as 65002;

    ipv4 {
        import filter import_owl;
        export filter export_owl;
        next hop self;
    };

    # Enable communities for OWL metrics
    enable route refresh;

    # Connection parameters
    connect retry time 30;
    hold time 90;
    keepalive time 30;

    # Multi-hop eBGP support
    multihop 64;

    # Error handling
    error wait time 60, 300;
}

# BGP peer border1
protocol bgp bgp_border1 {
    local as 65001;
    neighbor 172.20.0.12 as 65003;

    ipv4 {
        import filter import_owl;
        export filter export_owl;
        next hop self;
    };

    # Enable communities for OWL metrics
    enable route refresh;

    # Connection parameters
    connect retry time 30;
    hold time 90;
    keepalive time 30;

    # Multi-hop eBGP support
    multihop 64;

    # Error handling
    error wait time 60, 300;
}